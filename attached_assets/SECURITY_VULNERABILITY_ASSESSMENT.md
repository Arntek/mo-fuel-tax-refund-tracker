# Security Vulnerability Assessment

**Application:** MO Fuel Tax Refund Tracker  
**Date:** December 28, 2025  
**Assessment Type:** API and Data Access Security Review

---

## Overview

This document outlines security vulnerabilities identified in the API and data access patterns of the MO Fuel Tax Refund Tracker application. These findings should be addressed in priority order.

---

## ðŸ”´ CRITICAL Issues

### 1. âœ… COMPLETED: Sensitive Data Encryption (SSN, FEIN)

**Status:** Fixed on December 28, 2025

**Implementation:**
- Integrated `server/encryption.ts` module into account creation/update flows in `server/storage.ts`
- SSN, spouseSsn, and FEIN are now encrypted on write using `encryptSSN()` function
- Values are decrypted and formatted on read using `decryptSSN()` with `formatSSN()` and `formatEIN()`
- AES-256-GCM encryption with random IV per encryption
- Frontend auto-formats SSN (XXX-XX-XXXX) and EIN (XX-XXXXXXX) with real-time dash insertion

---

### 2. âœ… COMPLETED: Rate Limiting on Authentication Endpoints

**Status:** Fixed on December 28, 2025

**Implementation:**
- Installed `express-rate-limit` package
- Applied rate limits using `express-rate-limit`:
  - `/api/auth/request-code`: 3 requests per 15 minutes per IP/email (`authCodeRequestLimiter`)
  - `/api/auth/verify-code`: 5 attempts per 15 minutes per email (`authCodeVerifyLimiter`)
  - `/api/auth/signup`: 5 requests per hour per IP (`signupLimiter`)
- Rate limiters use email as primary key (fallback to IP)
- Returns clear error messages when limits exceeded

---

### 3. âœ… COMPLETED: Insecure Session Cookie Configuration

**Status:** Fixed on December 28, 2025

**Implementation:**
- Added `secure: process.env.NODE_ENV === "production"` flag to prevent cookie interception over HTTP in production
- Changed `sameSite: "lax"` to `sameSite: "strict"` for stronger CSRF protection
- Added `path: "/"` for explicit cookie scoping
- Applied to both verify-code and signup endpoints in `server/routes.ts`

---

## ðŸŸ  HIGH Issues

### 4. âœ… COMPLETED: IDOR Vulnerability: Vehicle Operations Missing Account Verification

**Status:** Fixed on December 28, 2025

**Implementation:**
- Added vehicle ownership verification at the start of PUT and DELETE vehicle endpoints
- Checks that the vehicle's `accountId` matches the account in the URL before any modification
- Returns 404 "Vehicle not found" if vehicle doesn't exist or belongs to different account
- Applied to both `PUT /api/accounts/:accountId/vehicles/:id` and `DELETE /api/accounts/:accountId/vehicles/:id`

---

### 5. âœ… COMPLETED: IDOR Vulnerability: Vehicle Member Endpoints

**Status:** Fixed on December 28, 2025

**Implementation:**
- Added vehicle ownership verification to all three vehicle member management endpoints
- Checks that the vehicle's `accountId` matches the account in the URL before any operation
- Applied to:
  - `GET /api/accounts/:accountId/vehicles/:vehicleId/members`
  - `POST /api/accounts/:accountId/vehicles/:vehicleId/members`
  - `DELETE /api/accounts/:accountId/vehicles/:vehicleId/members/:userId`

---

### 6. âœ… COMPLETED: User Enumeration Vulnerability

**Status:** Fixed on December 28, 2025

**Implementation:**
- Auth request-code endpoint now returns the same generic message regardless of whether email exists
- Emails are sent for all valid email addresses (needed for both login and signup flows)
- Response: `"If this email is registered, you will receive a login code."`
- Removed `userExists` field from response to prevent enumeration
- Note: Both login and signup require codes, so we always generate codes; the response simply doesn't reveal if email exists

---

### 7. âœ… COMPLETED: In-Memory ACL Storage (Lost on Restart)

**Status:** Fixed on December 28, 2025

**Resolution:** The ACL policy system was removed entirely as it was redundant. Access control for receipt images is now enforced exclusively at the route level in `GET /objects/:objectPath`:

1. **Authentication**: Requires valid session cookie
2. **Account Membership**: Verifies user is a member of the account that owns the object (extracted from path `.private/{accountId}/receipts/{uuid}`)
3. **Role-Based Access**: For "member" role users, additionally verifies they either uploaded the receipt OR are assigned to the vehicle

The in-memory ACL Map was serving no security purpose since:
- Files are stored in Replit's private object storage (no direct public URL access)
- All access goes through the authenticated `/objects/` route
- Route-level checks are the actual security enforcement

**What Was Kept:**
- `objectAcl.ts` now only contains `ObjectMetadata` interface and functions for storing content-type metadata (still in-memory, but losing this on restart just means MIME type defaults to `application/octet-stream`)

---

### 8. Missing Security Headers

**Location:** `server/index.ts`

**Problem:** No security headers are configured. Missing:
- Content-Security-Policy
- X-Frame-Options
- X-Content-Type-Options
- X-XSS-Protection
- Referrer-Policy
- Strict-Transport-Security

**Fix Required:**
Install and configure helmet.js:

```bash
npm install helmet
```

```typescript
import helmet from "helmet";

// Add before other middleware
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "https://js.stripe.com"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      frameSrc: ["https://js.stripe.com", "https://hooks.stripe.com"],
      connectSrc: ["'self'", "https://api.stripe.com"],
    },
  },
  crossOriginEmbedderPolicy: false,
}));
```

---

## ðŸŸ¡ MEDIUM Issues

### 9. Race Condition in Auth Code Verification

**Location:** `server/auth.ts` lines 128-138

**Problem:** Auth code verification and deletion are not atomic operations:

```typescript
export async function verifyAuthCode(email: string, code: string): Promise<boolean> {
  const authCode = await storage.getAuthCodeByEmailAndCode(email, code);
  
  if (!authCode) {
    return false;
  }

  await storage.deleteAuthCode(authCode.id);  // Gap between check and delete
  
  return true;
}
```

A race condition could allow the same code to be used multiple times if requests arrive simultaneously.

**Fix Required:**
Use a database transaction with atomic delete:

```typescript
export async function verifyAuthCode(email: string, code: string): Promise<boolean> {
  // Use a single atomic operation that deletes and returns the code
  const deleted = await storage.deleteAuthCodeIfValid(email, code);
  return deleted;
}

// In storage.ts
async deleteAuthCodeIfValid(email: string, code: string): Promise<boolean> {
  const result = await db
    .delete(schema.authCodes)
    .where(and(
      eq(schema.authCodes.email, email),
      eq(schema.authCodes.code, code),
      gte(schema.authCodes.expiresAt, new Date())
    ))
    .returning();
  return result.length > 0;
}
```

---

### 10. âœ… COMPLETED: Role Escalation Risk

**Status:** Fixed on December 28, 2025

**Implementation:**
- Role update endpoint now validates that role is one of allowed values: `["member", "admin"]`
- Prevents setting invalid roles like "owner" (ownership is determined by `account.ownerId`, not role field)
- Blocks attempts to change the account owner's role with clear error message
- Returns 400 error with message "Invalid role. Allowed values: member, admin" for invalid roles
- Returns 400 error with message "Cannot change account owner's role" when attempting to modify owner

---

### 11. Missing CSRF Protection

**Location:** Throughout `server/routes.ts`

**Problem:** No explicit CSRF tokens are implemented. While `SameSite: lax` cookies provide partial protection, it's not complete.

**Affected Operations:** All POST, PUT, DELETE endpoints

**Fix Required:**
1. Install csurf: `npm install csurf`
2. Add CSRF middleware:
```typescript
import csrf from 'csurf';

const csrfProtection = csrf({ cookie: true });

// Apply to state-changing routes
app.post("/api/auth/logout", authMiddleware, csrfProtection, async (req, res) => { ... });
```

3. Send CSRF token to client and include in requests

**Alternative:** If using a SPA, ensure proper CORS configuration and consider using custom headers for AJAX requests.

---

### 12. âœ… COMPLETED: Rate Limiting on Resource-Intensive Operations

**Status:** Fixed on December 28, 2025

**Implementation:**
- Applied rate limiting to protect against DoS and cost attacks:
  - Receipt upload with AI processing: 10 uploads per minute per account (`receiptUploadLimiter`)
  - VIN lookup (external API): 20 lookups per minute per user (`vinLookupLimiter`)
- Rate limiters use accountId/userId as primary key (fallback to IP)
- Returns clear error messages when limits exceeded
- Prevents abuse of OpenAI API costs and NHTSA VIN lookup service

---

## ðŸ”µ LOW Issues

### 13. Weak Email Validation

**Location:** `server/routes.ts` line 143

**Problem:** Basic regex email validation doesn't catch all invalid formats.

**Current Code:**
```typescript
if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
```

**Fix Required:**
Use a robust email validation library:
```bash
npm install validator
```

```typescript
import { isEmail } from 'validator';

if (!email || !isEmail(email)) {
  return res.status(400).json({ error: "Valid email required" });
}
```

---

### 14. âœ… COMPLETED: Error Information Disclosure

**Status:** Fixed on December 28, 2025

**Implementation:**
- Added `safeErrorMessage()` helper function to `server/routes.ts`
- In production (`NODE_ENV=production`), returns generic error message instead of exposing internal details
- In development, returns actual error message for debugging convenience
- Applied to critical error handlers that previously exposed error details (e.g., receipt upload)
- Prevents attackers from gaining information about internal system structure through error messages

---

### 15. âœ… COMPLETED: VIN Encryption

**Status:** Fixed on December 28, 2025

**Implementation:**
- Integrated `encryptVIN()` and `decryptVIN()` functions into vehicle CRUD operations in `server/storage.ts`
- VINs encrypted with AES-256-GCM plus HMAC-SHA256 search hash stored in `vinHash` column
- Added `vinHash` column to vehicles schema for secure lookups without decryption
- Values automatically decrypted when vehicles are retrieved from database

---

## Implementation Priority

| Priority | Issue | Effort | Impact |
|----------|-------|--------|--------|
| 1 | SSN/FEIN encryption (#1) | Medium | Critical - PII exposure |
| 2 | Auth rate limiting (#2) | Low | Critical - Brute force prevention |
| 3 | Secure cookie flags (#3) | Low | Critical - Session hijacking |
| 4 | Vehicle IDOR fixes (#4, #5) | Low | High - Data breach |
| 5 | Security headers (#8) | Low | High - XSS, clickjacking |
| 6 | User enumeration (#6) | Low | High - Privacy |
| 7 | ACL persistence (#7) | Medium | High - Access control |
| 8 | Role escalation (#10) | Low | Medium - Privilege escalation |
| 9 | Auth race condition (#9) | Medium | Medium - Token reuse |
| 10 | CSRF protection (#11) | Medium | Medium - State modification |
| 11 | Rate limiting general (#12) | Medium | Medium - DoS prevention |
| 12 | Email validation (#13) | Low | Low - Input validation |
| 13 | Error disclosure (#14) | Low | Low - Information leakage |
| 14 | VIN encryption (#15) | Low | Low - Data protection |

---

## Testing Recommendations

After implementing fixes, perform the following security tests:

1. **Authentication Testing:**
   - Verify rate limits block excessive requests
   - Test OTP brute force is prevented
   - Confirm session cookies have correct flags

2. **Authorization Testing:**
   - Attempt IDOR attacks on vehicle endpoints
   - Verify cross-account access is blocked
   - Test role escalation prevention

3. **Input Validation Testing:**
   - Test for SQL injection (should be protected by Drizzle ORM)
   - Test XSS in user input fields
   - Verify email validation

4. **Encryption Verification:**
   - Confirm SSN/FEIN values are encrypted in database
   - Verify decryption works correctly
   - Test that masked values display properly

5. **Security Headers:**
   - Use securityheaders.com to verify headers
   - Test CSP doesn't break application functionality

---

## Notes for Agent

When implementing these fixes:

1. **Test each fix individually** before combining
2. **Create database migrations** for schema changes
3. **Update tests** to cover security scenarios
4. **Document breaking changes** (e.g., user enumeration fix changes UX)
5. **Monitor logs** after deployment for blocked attacks
6. **Consider a security audit** after fixes are implemented
